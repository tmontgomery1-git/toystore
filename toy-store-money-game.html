<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Toy Store ‚Äî Count Your Coins!</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --sky: #FFF8E7;
    --wood: #8B5E3C;
    --wood-light: #C4885A;
    --sign: #E8392A;
    --sign2: #F7B731;
    --green: #2ECC71;
    --green-dark: #27AE60;
    --blue: #3498DB;
    --purple: #9B59B6;
    --pink: #E91E8C;
    --red: #E8392A;
    --shadow: rgba(0,0,0,0.15);
    --coin-penny: #B87333;
    --coin-nickel: #A8A9AD;
    --coin-dime: #C0C0C0;
    --coin-quarter: #D4A843;
    --coin-dollar: #2ECC71;
    --coin-five: #3498DB;
    --coin-ten: #E67E22;
    --coin-twenty: #9B59B6;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Nunito', sans-serif;
    background: linear-gradient(180deg, #87CEEB 0%, #B0E0FF 40%, #FFF8E7 100%);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== HEADER ===== */
  #header {
    text-align: center;
    padding: 18px 20px 10px;
    position: relative;
  }
  #header h1 {
    font-family: 'Fredoka One', cursive;
    font-size: clamp(2rem, 5vw, 3.2rem);
    color: var(--wood);
    text-shadow: 3px 3px 0 var(--sign2), 5px 5px 0 rgba(0,0,0,0.1);
    letter-spacing: 1px;
  }
  #header h1 span { color: var(--red); }

  #level-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-top: 6px;
    font-weight: 800;
    color: var(--wood);
    font-size: 1rem;
  }
  .star { color: var(--sign2); font-size: 1.3rem; }
  #score-display { background: var(--sign2); color: #fff; border-radius: 20px; padding: 3px 14px; font-size: 0.9rem; font-weight: 800; }

  /* ===== SHOP SCENE ===== */
  #shop {
    max-width: 700px;
    margin: 0 auto;
    padding: 0 16px;
  }

  /* Shelf */
  #shelf {
    background: linear-gradient(180deg, #D4956A 0%, #C4885A 60%, #8B5E3C 100%);
    border-radius: 16px 16px 8px 8px;
    padding: 18px 20px 14px;
    position: relative;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25), inset 0 2px 0 rgba(255,255,255,0.2);
    border: 3px solid #7A4F2A;
  }
  #shelf::before {
    content: 'üß∏ Toy Store üé†';
    font-family: 'Fredoka One', cursive;
    font-size: 1.2rem;
    color: var(--sign2);
    background: var(--red);
    position: absolute;
    top: -18px;
    left: 50%;
    transform: translateX(-50%);
    padding: 2px 20px;
    border-radius: 20px;
    border: 3px solid #7A0000;
    white-space: nowrap;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  }

  #product-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }

  #toy-emoji {
    font-size: clamp(3.5rem, 10vw, 5rem);
    filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
    animation: bob 2s ease-in-out infinite;
  }
  @keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

  #price-tag {
    background: #FFFDE7;
    border: 3px dashed var(--wood);
    border-radius: 12px;
    padding: 10px 18px;
    text-align: center;
    box-shadow: 3px 3px 0 rgba(0,0,0,0.15);
    transform: rotate(2deg);
  }
  #price-tag .label { font-size: 0.75rem; font-weight: 800; color: #999; text-transform: uppercase; letter-spacing: 1px; }
  #price-tag .price { font-family: 'Fredoka One', cursive; font-size: clamp(1.8rem, 5vw, 2.6rem); color: var(--red); line-height: 1; }
  #price-tag .toy-name { font-size: 0.85rem; font-weight: 700; color: var(--wood); margin-top: 2px; }

  /* ===== MASCOT & MESSAGE ===== */
  #mascot-area {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 10px 0 8px;
    justify-content: center;
  }
  #mascot { font-size: 2.2rem; animation: wiggle 3s ease-in-out infinite; }
  @keyframes wiggle { 0%,100%{transform:rotate(0)} 20%{transform:rotate(-8deg)} 40%{transform:rotate(8deg)} 60%{transform:rotate(-4deg)} 80%{transform:rotate(4deg)} }

  #speech-bubble {
    background: white;
    border-radius: 16px;
    padding: 8px 16px;
    font-size: clamp(0.85rem, 2.5vw, 1rem);
    font-weight: 700;
    color: #333;
    box-shadow: 0 3px 10px rgba(0,0,0,0.12);
    position: relative;
    max-width: 400px;
    border: 2px solid #eee;
    min-height: 40px;
    display: flex;
    align-items: center;
  }
  #speech-bubble::before {
    content: '';
    position: absolute;
    left: -12px; top: 50%;
    transform: translateY(-50%);
    border: 8px solid transparent;
    border-right-color: #eee;
  }
  #speech-bubble::after {
    content: '';
    position: absolute;
    left: -9px; top: 50%;
    transform: translateY(-50%);
    border: 7px solid transparent;
    border-right-color: white;
  }

  /* ===== REGISTER / TRAY ===== */
  #register-area {
    background: linear-gradient(135deg, #2c3e50, #3d5166);
    border-radius: 14px;
    padding: 14px 16px;
    margin: 8px 0;
    border: 3px solid #1a252f;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
  }
  #register-label {
    font-family: 'Fredoka One', cursive;
    color: var(--sign2);
    font-size: 0.9rem;
    letter-spacing: 1px;
    margin-bottom: 8px;
    text-align: center;
  }
  #tray {
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    min-height: 64px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 10px;
    align-items: center;
    border: 2px solid rgba(255,255,255,0.1);
  }
  .tray-coin {
    cursor: pointer;
    transition: transform 0.1s;
    animation: dropIn 0.2s ease-out;
    position: relative;
  }
  .tray-coin:hover { transform: scale(1.15); }
  @keyframes dropIn { from{transform:scale(0) rotate(-20deg);opacity:0} to{transform:scale(1) rotate(0);opacity:1} }
  .tray-empty { color: rgba(255,255,255,0.3); font-size: 0.85rem; font-style: italic; width: 100%; text-align: center; }

  #total-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
  }
  #total-label { color: rgba(255,255,255,0.7); font-size: 0.85rem; font-weight: 700; }
  #total-amount {
    font-family: 'Fredoka One', cursive;
    font-size: 1.8rem;
    color: var(--sign2);
    text-shadow: 0 0 10px rgba(247,183,49,0.5);
    transition: all 0.2s;
  }
  #total-amount.bump { animation: bump 0.2s ease-out; }
  @keyframes bump { 0%{transform:scale(1)} 50%{transform:scale(1.3)} 100%{transform:scale(1)} }

  #clear-btn {
    background: rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.8);
    border: none;
    border-radius: 8px;
    padding: 4px 12px;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  #clear-btn:hover { background: rgba(255,100,100,0.4); color: white; }

  /* ===== WALLET / COIN PICKER ===== */
  #wallet-area {
    background: linear-gradient(135deg, #f9f3e8, #f0e5cc);
    border-radius: 14px;
    padding: 12px 16px;
    border: 3px solid var(--wood-light);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  #wallet-label {
    font-family: 'Fredoka One', cursive;
    color: var(--wood);
    font-size: 0.9rem;
    letter-spacing: 1px;
    margin-bottom: 10px;
    text-align: center;
  }
  #coins-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }

  .coin-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    cursor: pointer;
    background: none;
    border: none;
    padding: 6px;
    border-radius: 12px;
    transition: transform 0.1s, background 0.1s;
  }
  .coin-btn:hover { transform: scale(1.15) translateY(-3px); background: rgba(0,0,0,0.06); }
  .coin-btn:active { transform: scale(0.95); }

  .coin-circle {
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-family: 'Fredoka One', cursive;
    box-shadow: 0 3px 0 rgba(0,0,0,0.3), inset 0 2px 0 rgba(255,255,255,0.3);
    border: 2px solid rgba(0,0,0,0.2);
    transition: transform 0.1s;
    user-select: none;
  }
  .coin-btn .coin-name { font-size: 0.62rem; font-weight: 800; color: #666; text-align: center; line-height: 1.1; }

  /* Coin sizes */
  .coin-penny  { width: 42px; height: 42px; background: radial-gradient(circle at 35% 35%, #E8A87C, #B87333, #7A4A1E); color: #fff; font-size: 0.75rem; }
  .coin-nickel { width: 48px; height: 48px; background: radial-gradient(circle at 35% 35%, #D0D0D5, #A8A9AD, #737477); color: #fff; font-size: 0.75rem; }
  .coin-dime   { width: 38px; height: 38px; background: radial-gradient(circle at 35% 35%, #E0E0E0, #C0C0C0, #888); color: #555; font-size: 0.75rem; }
  .coin-quarter{ width: 52px; height: 52px; background: radial-gradient(circle at 35% 35%, #F0D080, #D4A843, #9A7320); color: #fff; font-size: 0.8rem; }

  /* Bills */
  .bill-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    cursor: pointer;
    background: none;
    border: none;
    padding: 4px;
    border-radius: 8px;
    transition: transform 0.1s, background 0.1s;
  }
  .bill-btn:hover { transform: scale(1.08) translateY(-3px); background: rgba(0,0,0,0.06); }
  .bill-btn:active { transform: scale(0.95); }

  .bill-rect {
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Fredoka One', cursive;
    font-size: 1rem;
    box-shadow: 2px 3px 0 rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.3);
    border: 2px solid rgba(0,0,0,0.15);
    color: white;
    user-select: none;
  }
  .bill-1  { width: 64px; height: 30px; background: linear-gradient(135deg, #52C97A, #27AE60, #1A7A44); }
  .bill-5  { width: 64px; height: 30px; background: linear-gradient(135deg, #5DADE2, #2980B9, #1A5F88); }
  .bill-10 { width: 64px; height: 30px; background: linear-gradient(135deg, #F0A030, #E67E22, #A85510); }
  .bill-20 { width: 64px; height: 30px; background: linear-gradient(135deg, #BB8FD4, #9B59B6, #6C3483); }
  .bill-btn .coin-name { font-size: 0.62rem; font-weight: 800; color: #666; text-align: center; }

  /* ===== CHECK BUTTON ===== */
  #check-btn {
    display: block;
    width: 100%;
    margin: 12px 0 4px;
    padding: 14px;
    font-family: 'Fredoka One', cursive;
    font-size: 1.4rem;
    color: white;
    background: linear-gradient(135deg, var(--green), var(--green-dark));
    border: none;
    border-radius: 14px;
    cursor: pointer;
    box-shadow: 0 5px 0 #1A7A44, 0 8px 15px rgba(0,0,0,0.2);
    transition: transform 0.1s, box-shadow 0.1s;
    letter-spacing: 1px;
  }
  #check-btn:hover { transform: translateY(-2px); box-shadow: 0 7px 0 #1A7A44, 0 10px 20px rgba(0,0,0,0.2); }
  #check-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #1A7A44; }
  #check-btn:disabled { background: #ccc; box-shadow: 0 3px 0 #aaa; cursor: not-allowed; transform: none; }

  /* ===== LEVEL PROGRESS ===== */
  #progress-area {
    display: flex;
    gap: 6px;
    justify-content: center;
    margin: 6px 0 10px;
    flex-wrap: wrap;
  }
  .level-pip {
    width: 28px; height: 28px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 800;
    border: 2px solid rgba(0,0,0,0.15);
    cursor: default;
    transition: transform 0.2s;
  }
  .level-pip.done { background: var(--sign2); color: white; }
  .level-pip.current { background: var(--red); color: white; transform: scale(1.2); box-shadow: 0 0 0 3px rgba(232,57,42,0.3); }
  .level-pip.locked { background: #ddd; color: #aaa; }

  /* ===== OVERLAYS ===== */
  #overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  #overlay.show { display: flex; }
  #overlay-box {
    background: white;
    border-radius: 24px;
    padding: 30px 36px;
    text-align: center;
    max-width: 380px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes popIn { from{transform:scale(0.5);opacity:0} to{transform:scale(1);opacity:1} }
  #overlay-emoji { font-size: 4rem; margin-bottom: 10px; }
  #overlay-title { font-family: 'Fredoka One', cursive; font-size: 1.8rem; color: var(--red); margin-bottom: 8px; }
  #overlay-msg { font-size: 1rem; color: #555; font-weight: 600; margin-bottom: 20px; line-height: 1.4; }
  #overlay-btn {
    background: linear-gradient(135deg, var(--green), var(--green-dark));
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 32px;
    font-family: 'Fredoka One', cursive;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 4px 0 #1A7A44;
    transition: transform 0.1s;
  }
  #overlay-btn:hover { transform: translateY(-2px); }
  #overlay-btn:active { transform: translateY(2px); }

  /* ===== CONFETTI ===== */
  #confetti-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 200;
    overflow: hidden;
  }
  .confetti-piece {
    position: absolute;
    width: 10px; height: 10px;
    opacity: 0;
    animation: confettiFall linear forwards;
  }
  @keyframes confettiFall {
    0%   { opacity: 1; transform: translateY(-20px) rotate(0deg); }
    100% { opacity: 0; transform: translateY(100vh) rotate(720deg); }
  }

  /* ===== WRONG SHAKE ===== */
  .shake { animation: shake 0.4s ease-out; }
  @keyframes shake {
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-8px)}
    40%{transform:translateX(8px)}
    60%{transform:translateX(-6px)}
    80%{transform:translateX(6px)}
  }

  /* ===== CHANGE mode extra ===== */
  #change-hint {
    text-align: center;
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--purple);
    margin-top: 4px;
    min-height: 20px;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 480px) {
    .coin-quarter { width: 44px; height: 44px; }
    .coin-nickel  { width: 40px; height: 40px; }
    .bill-rect    { width: 56px; }
  }
</style>
</head>
<body>

<div id="confetti-container"></div>

<div id="header">
  <h1>üß∏ <span>Toy</span> Store Cash Register!</h1>
  <div id="level-bar">
    <span>‚≠ê Score: </span><span id="score-display">0</span>
    <span id="level-name-display" style="font-size:0.85rem; opacity:0.7;"></span>
  </div>
</div>

<div id="shop">

  <!-- Level pips -->
  <div id="progress-area"></div>

  <!-- Shelf + product -->
  <div id="shelf">
    <div id="product-display">
      <div id="toy-emoji">üé™</div>
      <div id="price-tag">
        <div class="label">Price</div>
        <div class="price" id="price-display">$0.00</div>
        <div class="toy-name" id="toy-name-display">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Mascot -->
  <div id="mascot-area">
    <div id="mascot">ü¶ä</div>
    <div id="speech-bubble"><span id="speech-text">Welcome! Let's count some money!</span></div>
  </div>

  <!-- Register / tray -->
  <div id="register-area">
    <div id="register-label">üí∞ YOUR REGISTER TRAY</div>
    <div id="tray"><span class="tray-empty">Click coins below to add them here!</span></div>
    <div id="total-display">
      <span id="total-label">Total in tray:</span>
      <div style="display:flex;align-items:center;gap:10px;">
        <button id="clear-btn" onclick="clearTray()">‚úï Clear</button>
        <span id="total-amount">$0.00</span>
      </div>
    </div>
  </div>

  <!-- Change mode hint -->
  <div id="change-hint"></div>

  <!-- Wallet -->
  <div id="wallet-area">
    <div id="wallet-label">üëú YOUR WALLET ‚Äî Click to add!</div>
    <div id="coins-grid"></div>
  </div>

  <!-- Check -->
  <button id="check-btn" onclick="checkAnswer()">üíµ Pay Now!</button>

</div>

<!-- Overlay -->
<div id="overlay">
  <div id="overlay-box">
    <div id="overlay-emoji">üéâ</div>
    <div id="overlay-title">Great job!</div>
    <div id="overlay-msg"></div>
    <button id="overlay-btn" onclick="nextLevel()">Next Level ‚Üí</button>
  </div>
</div>

<script>
// =========================================================
//  GAME DATA
// =========================================================

const TOYS = [
  {emoji:'üéà', name:'Balloon'},
  {emoji:'ü™Ä', name:'Yo-Yo'},
  {emoji:'üß©', name:'Puzzle'},
  {emoji:'üé™', name:'Circus Tent'},
  {emoji:'ü§ñ', name:'Robot'},
  {emoji:'üé†', name:'Carousel'},
  {emoji:'üß∏', name:'Teddy Bear'},
  {emoji:'üéØ', name:'Bullseye'},
  {emoji:'üöÇ', name:'Train'},
  {emoji:'üé®', name:'Paint Set'},
  {emoji:'üõπ', name:'Skateboard'},
  {emoji:'üéÆ', name:'Game Controller'},
  {emoji:'ü™Å', name:'Boomerang'},
  {emoji:'üéª', name:'Violin'},
  {emoji:'üöÄ', name:'Rocket Ship'},
  {emoji:'ü¶ï', name:'Dinosaur'},
  {emoji:'üé°', name:'Ferris Wheel'},
  {emoji:'üèÜ', name:'Trophy'},
];

const MASCOTS = ['ü¶ä','üê®','ü¶Ñ','üê∏','üêº','ü¶Å','üêô','ü¶â'];

// LEVELS definition
// type: 'exact' = pay exact; 'change' = give back change from a given bill
// coins: which denominations are available
const LEVELS = [
  // L1: pennies only, cents ‚â§ 5
  { name:'Pennies!', type:'exact', coins:['penny'], priceRange:[1,5], priceUnit:'cents' },
  // L2: pennies + nickels, ‚â§ 15c
  { name:'Nickels Join!', type:'exact', coins:['penny','nickel'], priceRange:[5,15], priceUnit:'cents' },
  // L3: pennies + nickels + dimes, ‚â§ 30c
  { name:'Dimes!', type:'exact', coins:['penny','nickel','dime'], priceRange:[10,30], priceUnit:'cents' },
  // L4: all coins, ‚â§ 75c
  { name:'Quarters!', type:'exact', coins:['penny','nickel','dime','quarter'], priceRange:[15,75], priceUnit:'cents' },
  // L5: all coins, up to $1.99
  { name:'$1 Bills!', type:'exact', coins:['penny','nickel','dime','quarter','dollar'], priceRange:[26,199], priceUnit:'dollars' },
  // L6: add $5
  { name:'$5 Bills!', type:'exact', coins:['penny','nickel','dime','quarter','dollar','five'], priceRange:[101,599], priceUnit:'dollars' },
  // L7: add $10
  { name:'$10 Bills!', type:'exact', coins:['penny','nickel','dime','quarter','dollar','five','ten'], priceRange:[201,999], priceUnit:'dollars' },
  // L8: add $20
  { name:'$20 Bills!', type:'exact', coins:['penny','nickel','dime','quarter','dollar','five','ten','twenty'], priceRange:[501,1999], priceUnit:'dollars' },
  // L9: making change ‚Äî $1
  { name:'Make Change!', type:'change', payWith:'dollar', coins:['penny','nickel','dime','quarter'], priceRange:[5,95], priceUnit:'cents', changeNote:'Pay with $1.00' },
  // L10: making change ‚Äî $5
  { name:'Change from $5!', type:'change', payWith:'five', coins:['penny','nickel','dime','quarter','dollar'], priceRange:[101,490], priceUnit:'dollars', changeNote:'Pay with $5.00' },
  // L11: making change ‚Äî $10
  { name:'Change from $10!', type:'change', payWith:'ten', coins:['penny','nickel','dime','quarter','dollar','five'], priceRange:[101,990], priceUnit:'dollars', changeNote:'Pay with $10.00' },
  // L12: making change ‚Äî $20
  { name:'Change from $20!', type:'change', payWith:'twenty', coins:['penny','nickel','dime','quarter','dollar','five','ten'], priceRange:[101,1990], priceUnit:'dollars', changeNote:'Pay with $20.00' },
];

const COIN_DATA = {
  penny:  { value:1,    label:'1¬¢',  display:'1¬¢',  size:'penny',   type:'coin' },
  nickel: { value:5,    label:'5¬¢',  display:'5¬¢',  size:'nickel',  type:'coin' },
  dime:   { value:10,   label:'10¬¢', display:'10¬¢', size:'dime',    type:'coin' },
  quarter:{ value:25,   label:'25¬¢', display:'25¬¢', size:'quarter', type:'coin' },
  dollar: { value:100,  label:'$1',  display:'$1',  size:'bill-1',  type:'bill' },
  five:   { value:500,  label:'$5',  display:'$5',  size:'bill-5',  type:'bill' },
  ten:    { value:1000, label:'$10', display:'$10', size:'bill-10', type:'bill' },
  twenty: { value:2000, label:'$20', display:'$20', size:'bill-20', type:'bill' },
};

const BILL_DISPLAY = { dollar:'$1', five:'$5', ten:'$10', twenty:'$20' };

// =========================================================
//  STATE
// =========================================================
let currentLevel = 0;
let currentPriceCents = 0;
let trayContents = []; // array of coin keys
let score = 0;
let wrongAttempts = 0;
let currentToy = null;
let targetCents = 0; // what they need to put in tray

// =========================================================
//  AUDIO (Web Audio API simple tones)
// =========================================================
let audioCtx = null;
function getAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playTone(freq, duration=0.15, type='sine', vol=0.3) {
  try {
    const ctx = getAudio();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = type; osc.frequency.value = freq;
    gain.gain.setValueAtTime(vol, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
    osc.start(); osc.stop(ctx.currentTime + duration);
  } catch(e){}
}
function playCoinSound() {
  playTone(880, 0.08, 'sine', 0.2);
  setTimeout(()=>playTone(1100, 0.06, 'sine', 0.15), 60);
}
function playSuccessSound() {
  [523,659,784,1047].forEach((f,i)=>setTimeout(()=>playTone(f,0.18,'sine',0.3),i*100));
}
function playWrongSound() {
  playTone(200, 0.3, 'sawtooth', 0.2);
}
function playCashRegister() {
  [880,1100,1320].forEach((f,i)=>setTimeout(()=>playTone(f,0.12,'square',0.15),i*60));
}

// =========================================================
//  FORMAT
// =========================================================
function formatCents(c) {
  if (c < 100) return c + '¬¢';
  const d = Math.floor(c/100), cents = c % 100;
  return '$' + d + '.' + String(cents).padStart(2,'0');
}
function formatDollars(c) {
  const d = Math.floor(c/100), cents = c % 100;
  return '$' + d + '.' + String(cents).padStart(2,'0');
}

// =========================================================
//  SETUP LEVEL
// =========================================================
function setupLevel(lvlIndex) {
  currentLevel = lvlIndex;
  trayContents = [];
  wrongAttempts = 0;

  const lvl = LEVELS[lvlIndex];
  const [min, max] = lvl.priceRange;

  // Pick price
  if (lvl.priceUnit === 'cents') {
    currentPriceCents = randInt(min, max);
    // Make it a "nice" number sometimes
    if (Math.random() > 0.4) currentPriceCents = Math.round(currentPriceCents/5)*5 || 5;
  } else {
    // dollars range given in cents
    currentPriceCents = randInt(min, max);
    // round to nearest 5c
    currentPriceCents = Math.round(currentPriceCents/5)*5;
  }

  // For change levels: target = (payWith amount) - price
  if (lvl.type === 'change') {
    const payAmt = COIN_DATA[lvl.payWith].value;
    // Ensure price < payAmt
    currentPriceCents = Math.min(currentPriceCents, payAmt - 5);
    targetCents = payAmt - currentPriceCents;
  } else {
    targetCents = currentPriceCents;
  }

  // Pick toy
  currentToy = TOYS[Math.floor(Math.random()*TOYS.length)];

  // Render UI
  renderPricetag();
  renderTray();
  renderWallet();
  renderProgress();
  updateSpeech();
  updateChangeHint();

  document.getElementById('level-name-display').textContent = '‚Äî ' + lvl.name;
}

function randInt(a,b) { return Math.floor(Math.random()*(b-a+1))+a; }

// =========================================================
//  RENDER
// =========================================================
function renderPricetag() {
  document.getElementById('toy-emoji').textContent = currentToy.emoji;
  document.getElementById('toy-name-display').textContent = currentToy.name;
  document.getElementById('price-display').textContent = formatDollars(currentPriceCents);
}

function renderTray() {
  const tray = document.getElementById('tray');
  const total = trayContents.reduce((s,k)=>s+COIN_DATA[k].value, 0);

  if (trayContents.length === 0) {
    tray.innerHTML = '<span class="tray-empty">Click coins below to add them here!</span>';
  } else {
    tray.innerHTML = '';
    // Group and show individual clickable pieces
    trayContents.forEach((key, idx) => {
      const cd = COIN_DATA[key];
      const el = document.createElement('div');
      el.className = 'tray-coin';
      el.title = 'Click to remove';
      if (cd.type === 'coin') {
        el.innerHTML = `<div class="coin-circle coin-${key}" style="width:${coinSize(key)}px;height:${coinSize(key)}px;font-size:${coinFontSize(key)};">${cd.display}</div>`;
      } else {
        el.innerHTML = `<div class="bill-rect ${cd.size}" style="width:50px;height:24px;font-size:0.85rem;">${cd.display}</div>`;
      }
      el.onclick = () => removeFromTray(idx);
      tray.appendChild(el);
    });
  }

  // Update total
  const totalEl = document.getElementById('total-amount');
  totalEl.textContent = formatDollars(total);
  totalEl.classList.remove('bump');
  void totalEl.offsetWidth;
  totalEl.classList.add('bump');
}

function coinSize(key) {
  return {penny:36,nickel:42,dime:32,quarter:46}[key] || 40;
}
function coinFontSize(key) {
  return {penny:'0.65rem',nickel:'0.7rem',dime:'0.6rem',quarter:'0.75rem'}[key] || '0.7rem';
}

function renderWallet() {
  const lvl = LEVELS[currentLevel];
  const grid = document.getElementById('coins-grid');
  grid.innerHTML = '';

  lvl.coins.forEach(key => {
    const cd = COIN_DATA[key];
    const btn = document.createElement('button');

    if (cd.type === 'coin') {
      btn.className = 'coin-btn';
      btn.innerHTML = `
        <div class="coin-circle coin-${key}" style="width:${coinSize(key)}px;height:${coinSize(key)}px;font-size:${coinFontSize(key)};">${cd.display}</div>
        <span class="coin-name">${key.charAt(0).toUpperCase()+key.slice(1)}</span>
      `;
    } else {
      btn.className = 'bill-btn';
      btn.innerHTML = `
        <div class="bill-rect ${cd.size}">${cd.display}</div>
        <span class="coin-name">${cd.display} Bill</span>
      `;
    }
    btn.onclick = () => addToTray(key);
    grid.appendChild(btn);
  });
}

function renderProgress() {
  const area = document.getElementById('progress-area');
  area.innerHTML = '';
  LEVELS.forEach((lvl, i) => {
    const pip = document.createElement('div');
    pip.className = 'level-pip ' + (i < currentLevel ? 'done' : i === currentLevel ? 'current' : 'locked');
    pip.textContent = i < currentLevel ? '‚úì' : (i+1);
    pip.title = lvl.name;
    area.appendChild(pip);
  });
}

function updateSpeech(msg) {
  if (msg) {
    document.getElementById('speech-text').textContent = msg;
    return;
  }
  const lvl = LEVELS[currentLevel];
  const msgs = lvl.type === 'exact'
    ? [
        `Can you pay exactly ${formatDollars(currentPriceCents)} for the ${currentToy.name}? üéâ`,
        `The ${currentToy.name} costs ${formatDollars(currentPriceCents)}. Count out the coins!`,
        `I need ${formatDollars(currentPriceCents)} please! What coins make that?`,
      ]
    : [
        `The ${currentToy.name} costs ${formatDollars(currentPriceCents)}. You pay with ${COIN_DATA[lvl.payWith].label}. What's the change?`,
        `Pay with ${COIN_DATA[lvl.payWith].label} for a ${formatDollars(currentPriceCents)} toy. Count the change back!`,
      ];
  document.getElementById('speech-text').textContent = msgs[Math.floor(Math.random()*msgs.length)];
}

function updateChangeHint() {
  const lvl = LEVELS[currentLevel];
  const hint = document.getElementById('change-hint');
  if (lvl.type === 'change') {
    hint.textContent = `üí° ${lvl.changeNote} ‚Üí give back ${formatDollars(targetCents)} in change`;
  } else {
    hint.textContent = '';
  }
}

// =========================================================
//  TRAY ACTIONS
// =========================================================
function addToTray(key) {
  trayContents.push(key);
  playCoinSound();
  renderTray();
  // Auto-hint if total > target
  const total = trayContents.reduce((s,k)=>s+COIN_DATA[k].value, 0);
  if (total > targetCents) {
    updateSpeech("Oops, that's too much! Click a coin in the tray to remove it. üòÖ");
  }
}

function removeFromTray(idx) {
  trayContents.splice(idx, 1);
  playCoinSound();
  renderTray();
  updateSpeech();
  updateChangeHint();
}

function clearTray() {
  trayContents = [];
  renderTray();
  updateSpeech();
  updateChangeHint();
}

// =========================================================
//  CHECK ANSWER
// =========================================================
function checkAnswer() {
  const total = trayContents.reduce((s,k)=>s+COIN_DATA[k].value, 0);

  if (total === targetCents) {
    // ‚úÖ Correct!
    score += Math.max(10, 30 - wrongAttempts*10);
    document.getElementById('score-display').textContent = score;
    playCashRegister();
    setTimeout(playSuccessSound, 200);
    spawnConfetti();
    showOverlay('success');
  } else {
    // ‚ùå Wrong
    wrongAttempts++;
    playWrongSound();
    document.getElementById('register-area').classList.add('shake');
    setTimeout(()=>document.getElementById('register-area').classList.remove('shake'), 500);

    let hint = '';
    if (total === 0) {
      hint = "Add some coins or bills first! ü™ô";
    } else if (total < targetCents) {
      const diff = targetCents - total;
      hint = `You need ${formatDollars(diff)} more! Keep going! üí™`;
    } else {
      const diff = total - targetCents;
      hint = `That's ${formatDollars(diff)} too much! Remove some. üòÖ`;
    }
    updateSpeech(hint);

    if (wrongAttempts >= 3) {
      giveHint();
    }
  }
}

function giveHint() {
  const lvl = LEVELS[currentLevel];
  // Find simplest combo
  const remaining = targetCents - trayContents.reduce((s,k)=>s+COIN_DATA[k].value, 0);
  const available = [...lvl.coins].reverse(); // big first
  let r = Math.abs(remaining);
  const suggestions = [];
  for (const k of available) {
    const v = COIN_DATA[k].value;
    const n = Math.floor(r/v);
    if (n > 0) { suggestions.push(`${n} √ó ${COIN_DATA[k].display}`); r -= n*v; }
  }
  if (suggestions.length > 0) {
    updateSpeech('üí° Hint: Try using ' + suggestions.join(', ') + '!');
  }
}

// =========================================================
//  OVERLAY
// =========================================================
function showOverlay(type) {
  const overlay = document.getElementById('overlay');
  const msgs = {
    success: [
      "Amazing counting! üéâ",
      "You're a money master! üí∞",
      "Ka-ching! Perfect! üõéÔ∏è",
      "The shopkeeper is happy! ü¶ä",
      "Exactly right! You're so smart! ‚≠ê",
    ]
  };

  if (type === 'success') {
    document.getElementById('overlay-emoji').textContent = ['üéâ','üåü','üí∞','üéä','‚≠ê'][Math.floor(Math.random()*5)];
    document.getElementById('overlay-title').textContent = 'Correct!';
    document.getElementById('overlay-msg').textContent = msgs.success[Math.floor(Math.random()*msgs.success.length)];
    const isLast = currentLevel >= LEVELS.length - 1;
    document.getElementById('overlay-btn').textContent = isLast ? 'üèÜ Play Again!' : 'Next Level ‚Üí';
  }
  overlay.classList.add('show');
}

function nextLevel() {
  document.getElementById('overlay').classList.remove('show');
  if (currentLevel >= LEVELS.length - 1) {
    currentLevel = 0;
    score = 0;
    document.getElementById('score-display').textContent = '0';
  } else {
    currentLevel++;
  }
  setupLevel(currentLevel);
}

// =========================================================
//  CONFETTI
// =========================================================
function spawnConfetti() {
  const container = document.getElementById('confetti-container');
  const colors = ['#E8392A','#F7B731','#2ECC71','#3498DB','#9B59B6','#E91E8C'];
  for (let i = 0; i < 60; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    const size = randInt(6,14);
    piece.style.cssText = `
      left: ${Math.random()*100}%;
      top: -20px;
      width: ${size}px; height: ${size}px;
      background: ${colors[Math.floor(Math.random()*colors.length)]};
      border-radius: ${Math.random()>0.5?'50%':'2px'};
      animation-duration: ${0.8+Math.random()*1.5}s;
      animation-delay: ${Math.random()*0.5}s;
      transform: rotate(${Math.random()*360}deg);
    `;
    container.appendChild(piece);
    setTimeout(()=>piece.remove(), 2500);
  }
}

// =========================================================
//  INIT
// =========================================================
// Randomize mascot
document.getElementById('mascot').textContent = MASCOTS[Math.floor(Math.random()*MASCOTS.length)];

setupLevel(0);
</script>
</body>
</html>
